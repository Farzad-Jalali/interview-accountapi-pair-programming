language: go
go:
- 1.11.x
install:
- if [[ -a .git/shallow ]]; then git fetch --unshallow --tags; fi
- go get golang.org/x/tools/cmd/goimports
env:
  global:
  - STOP_DOCKER=1
  - SECSCAN_IMAGE=288840537196.dkr.ecr.eu-west-1.amazonaws.com/tech.form3/secscan-go:latest
  - secure: nCFXjRUcx7IkCUNd8GGAB6AsUmxrl5FmNv8iRXarNU+161OZfD3J+3GYdMNP4MoqmTwCr+sNIA/Br2FfN5hQa9bxVlArwXFWvgGnA1BUVmexO46UWeGtQBzN6+eaUtIvJ1vz6ZAUjs0YclrTE8n+fqwfp/O96SHdDofI448XVgqsXLhj/giVZ7rR9Nl19agksfD6AmeSqmb12H6cuE65d8+8czoHzTfaJsPinzsTkCXVNSjT0Vk2mBVq8RtPIYgs3LOggzdQ4KkbmvtmZNOyHlQFEb0Als/zygdXS9S0tv/K1/AZihFYZuX4XUo0g/TdMMG98uqR6kpnr35ElAxj4oOUxua8biTBpMX0JvdD4MrvNDUpZqydtPcUEiO5oQuIZnzdvhY+faYF2cFLdV555Gc19DvvByA3gRFuws+wnKdx8bxghUlVCO4Xruz16jGedpRBqVLerF1zhnEyzB+0RjAazBG2HfhJGIbhol9BsqpuwEWGnnjfRfvyvhxl5kmEoj4NEos9X+ipPp91b/AhqmidFfc6C/P4YZaHxG8WILZL/Urn4RGDjMo3yVZloZw3fJ4/ujV+Jj19wTfP8LES6Gtw66R26ibu+Rr5lrU1pE4cTcspCRc1Gtwh+nG4KWDE36t5y+XDyxyYvL0ZDDWEgrvlcXKalAWFC6orRJeVtTc=
  - secure: QViuJAaoApWmYl3N1Ag4jQTZJnIrkP4xZ7hjJQEGJ1aEn0HiGKgaQ18LgiWhnTP1zmyqR7D2ry2XMaFPMsGBDT1QWuuUYsCTkU1sE7gcURMDkG8UyVLA000zjVNflE3DQB+ik5PMUCSkPDp9Y3Vhnw7CVJwfHAx2JXVSyJOthKpcOCdl61yP7vCbEALYKoDXxdKgeeuguVngfJ1rKiTAh1JIkTYLwHgyBg3CKycPmco33b3AO2AQ1dY7j1w5z4Hgk91XKFjZV6IBNchcm5HSqVFgHqoGjQ0oYRhAJarnAON0jfZ6ler+KoNgYPR/rQMRFR4AyE7Re/Xbtr1GYjokIXfs9P/Nzu3glSS87ysQfpvZn/5dmrk9UHbDjy8ZeH13N/Zh++PbZHRha+kOC9OozvydnjoXKJkGXBl27XuGD2Pi0J5QiEBkqOEiasrpl85ZOzvg1N/COsmlelWkoMXTc4oaUZPv+uXrtZ+NU4xkEGC5gtirS131jbgr69C1awsFGqQDj6rvusam7h6ev1f15Hb9dHpc91cBUAhZFB3WI9KHrezJwxVprSCBdu8xMgsLVcNSFEMHs3+1q7yam8XjcPxyDK6q8ALHSPspfycmOg7pihedV9gv6LLrKSjD2A1HjkSMQ33F0ZdJqVoxb4MCTFu1P60ywWmnGMjcq0/rwxQ=
  - secure: hEZKp+bqDKz8dNB9qT3/OW9Qiq3JWQRZzfOwJmS2q6ri6020MhQ3WkdZy67bQR/I1d3mjhdsIA5Cfz+WqSxDWY5knIUwDwyhj1u3/SQCfhrkJ0PVSs95lQnV7jsq6MplXbM8P4gpj1n4yM9cCYkeJUTAEaHBovsoJl5FgHLzfkKBhjwci6PSeUSWRqbmym738iQWGUlE+TRrQjayAT9u1Zs1ZQ6cKkwHaJUso3oFsVGNiBXIoc2fxlVYkAjvcpyt+Ye//AvaPeBz0a+8jJ1ZsZLcEmYgO4ya2mNi8cszfHozDfmhDVkdIaPvXdkTcvIppL7K0S+oGWCRxeKnQJji7vF2p7IaANQLX08Td/8rW5XHztvH2OfTxPl+qZnYGzqtnrEgVDcscb6VlkJMuEbisbtLhNy+Z3fkd9RARusa0VUBJ3/0fJfIetiQK0MDFFHy2N2RzBFnCqlTl4fnktYCchfELwnQ6tHxAUl9JNBhuBo1mxYoI4zf2cYEGep2iYSWL2kSw5yCS4h5TlgL/EQyemI9/UWZZF4R6QH0wBGCrAR+Pkq5oxJ5PZgxkWxoSNsooUqoyU9LScEKtjQ1voEiR1Z2KYQFaiObndt3ewlGSaunyvfTUG6o/hgul0J4HFIYfpU3jc7dEuKK67Mym+q53kt/wVzCuzVS1wFWbV+N234=
jobs:
  include:
  - stage: test
    name: "Run Go Tests"
    install:
      - export HOST_IP=$(/sbin/ip -o -4 addr list eth0 | awk '{print $4}' | cut -d/ -f1)
      - if [[ -a .git/shallow ]]; then git fetch --unshallow --tags; fi
      - pip install --user awscli
      - go get golang.org/x/tools/cmd/goimports
    script:
      - make
  - stage: test
    name: "Run Security Scans"
    before_cache:
      - >
        mkdir -p $HOME/docker && docker images -a --filter='dangling=false' --format '{{.Repository}}:{{.Tag}} {{.ID}}'
        | xargs -n 2 -t sh -c 'test -e $HOME/docker/$1.tar.gz || docker save $0 | gzip -2 > $HOME/docker/$1.tar.gz'
    before_install:
      - if [[ -d $HOME/docker ]]; then ls $HOME/docker/*.tar.gz | xargs -I {file} sh -c "zcat {file} | docker load"; fi
    install:
      - sudo pip install awscli
    script:
      - eval $(aws ecr get-login --region eu-west-1 --no-include-email)
      - docker run --rm -v $(pwd):/code -e TRAVIS -e SNYK_TOKEN -e REPO=$TRAVIS_REPO_SLUG $SECSCAN_IMAGE
