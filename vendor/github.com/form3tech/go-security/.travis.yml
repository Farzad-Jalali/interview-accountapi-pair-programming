language: go
go:
- 1.9.x
env:
  global:
  - STOP_DOCKER=1
  - SECSCAN_IMAGE=288840537196.dkr.ecr.eu-west-1.amazonaws.com/tech.form3/secscan-go:latest
  - secure: AofJWC4XZz5rJikglBqDRZOcrxWxhNsYHvlG1p057Bmgu6bjU/NZkhD7+m6zwA4J02BzDq7VNX749IrhxoYshAWBShesoJxJWQOIaH66s2MqA1Jw4hUPXc/fffLqvMF0h7PvQ9sZOSYIWoaQ9FEZBq5RAMBNdjoIHeXi+jJKaVSEfR2yA+TvypLsSIexhTVQLe78ebV+9mAoxmIcVy9gIGvBhmVk2k57+/kktrxeBCTa/geAugF+W0Z4lUBJ8xXoD03R0sFTdr8y9WufhA9CM+fvsrcsF4DxK0unzd5gfqN5ckkFk7TaINUd82LpHbsOAdvN9AdzCoP3q95AYDHeFgPvUVWxIt3BghRJCLXS47TlGsv398QWPaWJ7K6z7jbMXQKdy1fwXJm8wzK2F4L9oCWLIW22FxI+5NKJGru4IL4LDjx/rEY6u9EGyu7rCeY6x2vrxvc9leNHA7slGF+mzb5muLYv74/uNDiEShkfZVBdp4hQ1EYZpYIu4UqrI+KNFsyrcAVOgl4NE1klcbV96WoiCOb/yIMv4+zxAAxh8I88jFuHpQTTp4xdePpaeWdCjxXgvxkl1PZzNKf2TxPSGhBgCY1WViqw7BPiFqI/oHhvR8sLk6Rko9ajRA0UAL290swlgdxtvgkymhhsKklo15cEocvHAnF6D53U9lDg0uM=
  - secure: A/qaIZV9tstU8z4g9+vZ39eaFlEOKThmDUByx3Abj0hVJlPa64kghLY0mTY+py48uVbGyUY1sSrWXlgRBMwYDyxuxWWPHSWw9BodxKrtqBzS0G4yKTsdDGqxlpNGnfAeHwR4gMdwyewFCqEE2AXTt5Wdv+4UMMPVllnlvNr1eAq6Wdr5lan0XRJEpOypqXBbGL11HnSxoX9JBCvihT2fBPcOhMfhXIY/yehrjWjNGTCK0cRZkqYa5ctybwFf6ms2aH4l/P0h219m6lW80LIrgoXzwFc35o86z6b8h4n2gZSahDaCW5VGXsk+mMCanAVeYhZtQFouG9cUkM6BjHuTO2Kewfgbivyr3QF3Nw5jEAo9bl4yyiUGB+g8U8AQWyOa6kK8fq9ZYpxwekBlIrg4BoNAIW1tR7bQAGFxqRO6j2fb3Ksye8oM8EWz/R2epvCW3ngB9GXk9Ykm6wdFMHS0a0oyLrbb/tp3CyOK/PfJEdo7iF6oi1MF46o9CEDFnHUsLGz7nETmUkY76I53T3UtG2SULweQkktW2SgzmF/JE/Lq6VEL7gXw7dy2wvXg+NrC7dfrd6hvq80lpQd2WuAcweLjofaMFUJOSyDg5tzr2Dd8HtUrcomAwEW4NdiPgod9r16dmDUoJ7bNKf28OD8C9TNmVk2MJHD5umCDvxd3RkA=
  - secure: lRuWC7ZieT78/H0duhff1M0S2axR6oU1GFfZxXj886x6F3gtV3r0nTR4TMjotQ+pfbXd6kbqY2nr9w2h6E1YisrngSBXBf8EAe6Pd7AEC9XjCjRSpVtOBTvBPd1JT8nYP5Uw17gtnhUvSWHUnZO2eu4qHEPdoODMvGuHnbVhhDH/wDeB/RbxpsasUF3aXUwLl6LIWAzYtNc8mHXy7MPZjW/Vi4XrN+f4EHKYzXA9KuGpOCV868QHJzCBGhOEfegoOUYYPXXVvZioILBDwi7OTTFxE8zSeggsCaF1M2gwCvehNmZDzS2rWPjpUrFd9UwKGji9ClzK+XH65k4metwpHUBx146gV3yQfPd7XKgicSBW19uWfkrjMlNOcbE8p0zBp/5VDi7oshNL15mIHNptdQ9I4pOb4gzBIgOyjEyzoo/EXo5GcwFX7lKWyro9OtPRzxxjSKcAmhQn5iH5D0MhWk/oAB92GVtpnJSedShFmHwCM62YoPmie5uOWUkvFY6eskiPTeGMjOQhOAEkMgvs357aokmAnAe1plIXtf3nxjrwg3kJUkPmsYLi/OrOxAy5ucgf6VKH4q2B6gS1Z+wjLRN8D/H0J7jLjhViKmWyZAwDzjaoRPx2WzooYA3u6/2J20Fc9sL1+gJmVq+f+VPAMIIHagjMgrCQ4gDZHNYj/HQ=
jobs:
  include:
  - stage: test
    name: Run Go Tests
    install:
    - export HOST_IP=$(/sbin/ip -o -4 addr list eth0 | awk '{print $4}' | cut -d/
      -f1)
    - if [[ -a .git/shallow ]]; then git fetch --unshallow --tags; fi
    - pip install --user awscli
    - go get golang.org/x/tools/cmd/goimports
    script:
    - make
  - stage: test
    name: Run Security Scans
    before_cache:
    - 'mkdir -p $HOME/docker && docker images -a --filter=''dangling=false'' --format
      ''{{.Repository}}:{{.Tag}} {{.ID}}'' | xargs -n 2 -t sh -c ''test -e $HOME/docker/$1.tar.gz
      || docker save $0 | gzip -2 > $HOME/docker/$1.tar.gz''

'
    before_install:
    - if [[ -d $HOME/docker ]]; then ls $HOME/docker/*.tar.gz | xargs -I {file} sh
      -c "zcat {file} | docker load"; fi
    install:
    - sudo pip install awscli
    script:
    - eval $(aws ecr get-login --region eu-west-1 --no-include-email)
    - docker run --rm -v $(pwd):/code -e TRAVIS -e SNYK_TOKEN -e REPO=$TRAVIS_REPO_SLUG
      $SECSCAN_IMAGE
notifications:
  slack: form3:SLG0PifAeMC7xowWEt2rjFZn
